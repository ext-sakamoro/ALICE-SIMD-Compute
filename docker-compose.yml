version: "3.9"
services:
  frontend:
    build: { context: ., dockerfile: docker/Dockerfile.frontend }
    ports: ["3000:3000"]
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
    depends_on: [api-gateway]
    networks: [simd-net]
  api-gateway:
    build: { context: ., dockerfile: docker/Dockerfile.api-gateway }
    ports: ["8080:8080"]
    environment:
      - CORE_ENGINE_URL=http://core-engine:8081
      - JWT_SECRET=${JWT_SECRET}
    depends_on: [core-engine]
    networks: [simd-net]
  core-engine:
    build: { context: ., dockerfile: docker/Dockerfile.core-engine }
    ports: ["8081:8081"]
    networks: [simd-net]
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
    volumes: [redis-data:/data]
    networks: [simd-net]
  postgres:
    image: postgres:16-alpine
    ports: ["5432:5432"]
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-alice_simd}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes: [postgres-data:/var/lib/postgresql/data, ./database/migrations:/docker-entrypoint-initdb.d]
    networks: [simd-net]
volumes: { postgres-data: {}, redis-data: {} }
networks: { simd-net: { driver: bridge } }
